## 現在動作しているもの
- **[NEW] 患者編集ページ（/patients/[patientId]/edit）をServer Component＋Client Component分離し、update処理をServer Action（actions.ts）に分離。UI/UX・バリデーション・トースト等はClient側で維持し、Next.js 15＋Supabase推奨構成にリファクタリング。**
- **[NEW] 全身機能評価新規登録ページ（/patients/[patientId]/examinations/physical-assessment/new）をServer Component＋Client Component分離し、insert処理をServer Action（actions.ts）に分離。UI/UX・バリデーション・トースト等はClient側で維持し、Next.js 15＋Supabase推奨構成にリファクタリング。**
- **[NEW] 口腔機能検査編集ページ（/patients/[patientId]/examinations/oral-function-assessment/[oralFunctionAssessmentId]/edit/page.tsx）の既存データ取得（select）もServer Action（fetchOralFunctionExam, fetchPatientData）に分離し、Client Componentから直接サーバー専用supabaseクライアントを呼ばないNext.js 15推奨構成にリファクタリング。UI/UX・入力ロジック・バリデーション・トースト等は一切変更せず、型エラー・ランタイムエラーも解消。**
- **[NEW] 口腔機能検査新規登録ページ（/patients/[patientId]/examinations/oral-function-assessment/new/page.tsx）のSupabase insert処理をServer Action（actions.ts）に分離し、UI/UX・入力ロジック・バリデーション・トースト・一時保存・タブUI等は一切変更せず、Next.js 15＋Supabaseの推奨構成にリファクタリング。params.patientIdの型エラーも最小限の修正で解消。**
- **[NEW] 新規患者登録ページ（/patients/new）を完全Server Component化し、Server Action＋Formパターンでサーバー専用supabaseクライアント（lib/supabaseClient.ts）を利用する構成に刷新。use client・useRouter・useCreatePatient・PatientForm.tsx等のクライアントロジックを全廃止し、バリデーション・エラー処理もサーバー側で一元化。Next.js 15の推奨パターンに完全準拠。**
- **[NEW] Supabase認証・ルートガード（Next.js 15 middleware＋Server Component構成）を導入。/patients・/settings配下はmiddlewareでセッション必須、loginページはServer Component＋Clientラッパー構成、lib/supabaseClient.tsはサーバー専用に分離。認証UI・リダイレクト・ガードが安定動作**
- **[NEW] Next.js 15＋Supabase公式UI＋middleware認証の完全連携を実現。AuthClient.tsxでsupabase.auth.onAuthStateChange＋getSession併用により、ログイン直後の/patientsリダイレクトが確実に動作するようになった。**
- **[NEW] middleware.tsを/app配下からルート直下（/middleware.ts）に移動したことで、Next.jsの認証ガード・ルートガードが正常動作するようになった。配置場所の誤りが原因でmiddlewareが一切発火しない問題を解消。**
- **[NEW] compareData（旧comparetest）による評価推移ロジックをapp/patients/[patientId]/page.tsxに実装。最大4件分の評価推移を算出し、components/ManagementGuidanceRecordSheet.tsxに渡す設計に統一**
- **[NEW] ManagementGuidanceRecordSheet.tsxで、評価値（1:改善, 2:著変なし, 3:悪化）を「評価: n ラベル（例: 評価: 2 著変なし）」の形式で全セル・ヘッダー下に表示するようUI/ロジックを強化**
- **[NEW] 管理指導記録簿枠組みUI（components/ManagementGuidanceRecordSheet.tsx）を新規作成し、/patients/[id]ページに追加**
- **[NEW] 管理指導記録簿印刷専用ページ（/patients/[id]/management-guidance-record/print）を新規作成し、枠組みUIを配置**
- **[NEW] /patients/[id]ページの管理指導記録簿カード部分に「印刷ページへ」ボタンを追加し、印刷専用ページへ遷移可能に**
- **[NEW] /printページで印刷時にヘッダー（navbar）が消えるTailwind print:hidden制御を導入。pathname.includes('/print')で判定し、要件通りの印刷UIを実現**
- **[NEW] 口腔乾燥・咬合力低下・咀嚼機能低下・嚥下機能低下の「該当基準」欄を、oralFunctionAssessmentJudge.tsのgetAllCriteriaDetails APIで全評価方法・基準値を常時改行区切りで表示するよう修正**
  - printページで全ての方法・基準値を明示し、現場運用・拡張性・一貫性を担保
  - API追加により他画面・他用途への再利用も容易
- **[NEW] 管理計画書印刷ページ（/patients/[patientId]/examinations/oral-function-assessment/[oralFunctionAssessmentId]/management-plan-edit/print）の「口腔機能の状態」テーブルをoralFunctionAssessmentJudge.tsのtoResultStruct共通ロジックに統一**
  - すべての検査項目（検査値・基準値・判定）がoralFunctionAssessmentJudge.tsの一元管理ロジックで出力される
  - 他ページと完全に揃った表示・判定・基準値となり、保守性・信頼性が大幅向上
  - 型不整合・判定ズレ・基準値の食い違いが根本的に解消
  - 今後の拡張・他画面再利用も容易
- **[NEW] 管理指導記録簿の一括保存UI/UXを実装。各列の保存ボタンを廃止し、テーブル下部に「一括保存」ボタンを新設。formState全体をAPI Routeで一括保存する設計に刷新**
- **[NEW] compareData・formState・API Routeのsnake_caseカラム名対応（general_condition_note等）**
- 患者一覧（/patients）画面のUI/UXリファイン
- **[NEW] 口腔機能検査（TCI/舌苔指数）のロジックを6ブロック→9ブロック（舌前方・中央部・後方部×左中央右）に統一。合計スコア・TCI計算式・判定基準（TCI≧50→低下（✕）、TCI≦50→正常（〇））を正規化。**
- **[NEW] lib/oralFunctionAssessmentJudge.tsのtoResultStruct/judgeOralHygieneStatus等を修正し、全画面で共通ロジックを利用。**
- **[NEW] components/ExaminationDetailClient.tsxのUIも9ブロック・合計スコア・TCI・判定が正しく表示されるよう修正。**
- **[NEW] TypeScript型エラーも型ガードで解消。**
- **[NEW] 動作確認にはログインが必要なため、UI確認はユーザー側で実施。**
- 詳細ページ遷移をカルテ番号から患者ID（id）ベースに統一
- 年齢計算をsupabaseのpatientsテーブルの誕生日から常に算出するよう統一
- 口腔機能検査データの型変換・判定ロジックを全面見直し。スコア・測定値はnumber型で保持し、型不整合・丸め・判定ズレを根本解消。全画面でDB値と完全一致するよう統一。
- OralFunctionExamData型をstring→number | undefined型に修正。全データ変換部（app/patients/[patientId]/page.tsx, app/patients/page.tsx, components/ExaminationDetailClient.tsx）でスコア・測定値をnumber型で渡すよう統一。
- toResultStruct共通化により、全画面でsupabase値→同一出力・同一判定・同一表示・同一日付が保証されるようになった。
- 印刷ページ・詳細ページ・n/7表示など全ての画面でtoResultStructのみを使うよう統一。舌苔の付着程度（TCI%）や計測日も正しく表示されるよう修正。
- **/app配下の全画面で性別（gender）の表記をmale/femaleから「男性」「女性」へ統一。DB値はそのまま、画面表示のみ変換。**
- （従来の動作確認済み機能も維持）

## 今後実装すべきもの
- **TCI/舌苔指数ロジックの今後の拡張・他画面再利用性の向上・テストケース追加**
- 身体機能評価詳細ページのさらなるUX改善・バリデーション強化・印刷連携・他画面再利用性の向上
- 他画面・他用途への判定ロジック再利用、判定基準の柔軟な拡張、UI/UX仕様のさらなる最適化
- 患者編集画面の更なるUX改善・バリデーション強化・エラーハンドリングの拡充
- karte_noバリデーション・重複チェック・エラー詳細表示の実装
- 管理計画書作成ページのさらなるUX改善・バリデーション・保存/プレビュー連携
- 口腔機能管理計画セクションのUIリファイン・保存機能
- 必要に応じてAPI連携・保存・印刷連携の強化
- 他セクションのUI/UX最適化
- ドキュメント・学びの随時反映
- **[TODO] 管理指導記録簿の一括保存APIの最適化（bulk update/transaction化）、バリデーション強化、エラー時のUI/UX改善**
- **[TODO] Supabase認証・ルートガードの拡張（医院単位のロール管理、認証エラー時のUI/UX改善、サインアウト・セッション切れ時の挙動最適化など）**

## 現在のステータス
- **[NEW] 口腔機能検査（TCI/舌苔指数）の9ブロック化・合計スコア/TCI/判定ロジックの共通化・UI修正が完了。lib/oralFunctionAssessmentJudge.tsのtoResultStruct/judgeOralHygieneStatusを全画面で利用し、UIも9ブロック・合計スコア・TCI・判定が正しく表示されるよう統一。TypeScript型エラーも型ガードで解消。**
- **[NEW] 新規患者登録ページ（/patients/new）が完全Server Component化・Server Action＋Formパターン・サーバー専用supabaseクライアント利用・バリデーション/エラー処理もサーバー側で一元化し、Next.js 15の推奨パターンに完全準拠して安定動作**
- **[NEW] Supabase認証・ルートガード（Next.js 15 middleware＋Server Component構成）が安定動作。/patients・/settings配下はmiddlewareでセッション必須、loginページはServer Component＋Clientラッパー構成、lib/supabaseClient.tsはサーバー専用に分離。**
- **[NEW] compareDataロジックにより、口腔機能評価の推移（最大4件分）が数字＋ラベル（例: 評価: 2 著変なし）でUIに正しく反映されるようになった**
- **[NEW] 管理指導記録簿枠組みUI・印刷専用ページ・遷移ボタンが実装され、患者詳細ページから印刷ページへの遷移が可能になった**
- **[NEW] 口腔乾燥・咬合力低下・咀嚼機能低下・嚥下機能低下の「該当基準」欄がoralFunctionAssessmentJudge.tsのgetAllCriteriaDetails APIで全方法・基準値を常時改行区切りで表示するようになり、現場運用・拡張性・一貫性が担保された**
- **[NEW] 管理計画書印刷ページの「口腔機能の状態」テーブルがoralFunctionAssessmentJudge.tsのtoResultStruct共通ロジックで一元管理され、全画面で同一出力・同一判定・同一基準値・同一日付が保証されるようになった**
- **[NEW] 管理指導記録簿の一括保存UI/UXが実装され、全ての入力内容をまとめて保存できるようになった**
- 患者一覧画面のUI/UX・バグ修正により、現場運用に即した一覧・遷移・年齢表示・レイアウトが安定動作
- 口腔機能検査データの型変換・判定ロジックのnumber型統一により、全画面でDB値と完全一致する正確な判定・表示が実現
- **/app配下の全画面で性別（gender）の表記が「男性」「女性」に統一され、male/femaleがそのまま表示されることはなくなった。**
- （従来の安定動作状況も維持）

## 既知の課題・懸念点
- **TCI/舌苔指数の今後の拡張・他画面再利用性・テストデータの充実**
- 身体機能評価詳細ページのバリデーション・UX改善・印刷連携強化
- 患者編集画面のバリデーション・UX改善・エラーハンドリング強化
- 患者基本情報フォームのカルテ番号（karte_no）バリデーション・UI/UX最適化
- 管理計画書作成ページのバリデーション・保存/プレビュー連携
- 口腔機能管理計画セクションのさらなるUX改善
- API連携・保存・印刷連携の強化
- 他セクションのUI/UX最適化
- Supabaseデータ取得時のID不一致・データ欠損時のエラー検知・デバッグパターンの徹底
- **[NEW] Supabase認証・ルートガードの運用・拡張に関する課題（医院単位のロール管理、認証エラー時のUI/UX、サインアウト・セッション切れ時の挙動など）**
- **[FIXED] middleware.tsの配置場所が/app配下だったため認証ガードが一切発火しなかったが、ルート直下に移動することで解決。今後はmiddleware.tsは必ずルート直下に配置することを徹底。**
- **[NEW] 管理指導記録簿の一括保存APIの最適化（bulk update/transaction化）、バリデーション強化、エラー時のUI/UX改善**

## プロジェクト意思決定の変遷
- **[NEW] 口腔機能検査（TCI/舌苔指数）は9ブロック・合計スコア/TCI/判定ロジックをlib/oralFunctionAssessmentJudge.tsのtoResultStruct/judgeOralHygieneStatusで一元管理し、全画面で共通ロジックを利用する方針に統一。**
- **[NEW] TypeScript型エラーはtypeof/プロパティ存在チェックで安全に解消。**
- **[NEW] 患者編集ページ（/patients/[patientId]/edit）も、updateはServer Action経由・サーバー専用supabaseクライアント利用、UI/UX・バリデーション・トースト等はClient Componentで一元管理する方針に統一**
- **[NEW] 全身機能評価新規登録ページ（/patients/[patientId]/examinations/physical-assessment/new）も、insertはServer Action経由・サーバー専用supabaseクライアント利用、UI/UX・バリデーション・トースト等はClient Componentで一元管理する方針に統一**
- **[NEW] 口腔機能検査編集ページ（edit/page.tsx）は既存データ取得（select）もServer Action（fetchOralFunctionExam, fetchPatientData）経由で実行し、Client Componentから直接サーバー専用supabaseクライアントを呼ばない構成に統一。UI/UX・ロジックは一切変更せず、Next.js 15推奨パターンを徹底。**
- **[NEW] 口腔機能検査新規登録ページ（oral-function-assessment/new/page.tsx）はUI/UX・入力ロジック・バリデーション・トースト等は一切変更せず、Supabase insertのみServer Action（actions.ts）経由で実行する構成に統一。lib/supabaseClient.tsのサーバー専用クライアントを利用。**
- **[NEW] 新規患者登録ページ（/patients/new）は完全Server Component化・Server Action＋Formパターン・サーバー専用supabaseクライアント利用・バリデーション/エラー処理もサーバー側で一元化し、Next.js 15の推奨パターンに完全準拠する方針に統一**
- **[NEW] Supabase認証・ルートガードはNext.js 15のmiddleware＋Server Component構成で統一。lib/supabaseClient.tsはサーバー専用、loginページはServer Component＋Clientラッパー構成で安全に分離。クライアントは直接supabase-jsを使う。**
- **[NEW] Next.js 15＋Supabase公式UI＋middleware認証の完全連携には、クライアント側で@supabase/auth-helpers-nextjsのcreatePagesBrowserClient()（引数なし、storage: 'cookie'デフォルト）で初期化し、Auth UIにはこのクライアントを渡す。AuthClient.tsxのuseEffectでsupabase.auth.onAuthStateChange＋getSession併用により、ログイン直後のリダイレクトを確実に行うパターンを採用。**
- **[NEW] middleware.tsは必ずプロジェクトのルート直下に配置すること。サブディレクトリでは一切認識されない。今回の配置修正で認証ガードが正常動作するようになった。**
- **[NEW] compareDataロジックと数字＋ラベル表示のUIパターンを全画面で徹底する方針に統一**
- **[NEW] 管理指導記録簿枠組みUI・印刷専用ページ・遷移ボタンは、現場運用・印刷業務の効率化・一貫性を重視し、枠組み→印刷ページ→遷移ボタンの流れで実装する方針に統一**
- **[NEW] 口腔乾燥・咬合力低下・咀嚼機能低下・嚥下機能低下の「該当基準」欄はoralFunctionAssessmentJudge.tsのgetAllCriteriaDetails APIで全方法・基準値を常時改行区切りで表示する方針に統一**
- **[NEW] 管理計画書・詳細ページ・n/7表示など全ての画面でtoResultStruct共通ロジックを使い、supabase値→同一出力・同一判定・同一基準値・同一日付を保証する方針に統一**
- **/app配下の性別表記はDB値（male/female）はそのまま、画面表示のみ「男性」「女性」に変換する方針に統一**
- **[NEW] 管理指導記録簿の一括保存UI/UX・API一括更新設計を全画面で徹底する方針に統一**
- 患者詳細ページ遷移は必ず患者ID（id）ベースで行う
- 年齢はpatientsテーブルの誕生日から常に自動計算して表示
- React keyはid優先で一意性を担保し、karte_noがnullでもバグが起きないようにする
- 見出しやボタンのレイアウトはflex・min-w・max-w等で横並びを維持
- OralFunctionExamData型・データ変換・判定ロジックのnumber型統一パターンを確立。今後の拡張・他画面再利用も容易
- 型不整合や意図しない丸め・判定ズレが発生しない設計を全画面で統一
- supabaseから同じ値を取得した場合、全ての画面でtoResultStructを通じて同じ出力・同じ判定・同じ日付表示になることを保証
- （従来の意思決定も維持）
